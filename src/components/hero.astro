---
import Profile from '../components/profilepic.astro';
import Brief from '../components/brief.astro';
import Skills from '../components/skill.astro';
import Contact from '../components/contact.astro';

const base = import.meta.env.PUBLIC_BASE_URL;
---

<div
  id="hero-section"
  class="relative flex flex-row gap-4 justify-center items-center w-full h-screen"
>
  <div
    id="scroll-indicator-top"
    class="absolute top-4 left-1/2 -translate-x-1/2 z-20 transition-opacity duration-300 opacity-0 pointer-events-none text-primary"
  >
    <div class="animate-bounce p-2">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="4"
        stroke="currentColor"
        class="w-6 h-6"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
      </svg>
    </div>
  </div>

  <div id="hero-carousel" class="carousel carousel-vertical h-screen overflow-hidden scroll-smooth">
    <div class="carousel-item min-h-screen">
      <Brief />
    </div>
    <div class="carousel-item min-h-screen">
      <Skills />
    </div>
    <div class="carousel-item min-h-screen">
      <div class="flex flex-col justify-center h-screen">
        <Contact />
      </div>
    </div>
  </div>

  <div
    id="scroll-indicator-bottom"
    class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 transition-opacity duration-300 pointer-events-none text-primary"
  >
    <div class="animate-bounce p-2">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="4"
        stroke="currentColor"
        class="w-6 h-6"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
      </svg>
    </div>
  </div>

  <div style="view-transition-name:profile;">
    <div class="tooltip tooltip-primary">
      <div class="tooltip-content">
        <div class="animate-bounce text-primary-content -rotate-3 text-2xl font-black">
          Click for more!!!
        </div>
      </div>
      <a href={base + 'about/'}>
        <Profile />
      </a>
    </div>
  </div>
</div>

<script>
  const heroSection = document.getElementById('hero-section');
  const carousel = document.getElementById('hero-carousel');
  const topIndicator = document.getElementById('scroll-indicator-top');
  const bottomIndicator = document.getElementById('scroll-indicator-bottom');

  let isHeroScrollActive = false;

  // 1. UI Logic: Toggle indicators based on carousel scroll position
  const updateIndicators = () => {
    if (!carousel) return;

    const { scrollTop, scrollHeight, clientHeight } = carousel;
    // Use a small buffer (10px) for "top" detection
    const isAtTop = scrollTop <= 10;
    // Math.ceil ensures we handle sub-pixel rendering differences
    const isAtBottom = Math.ceil(scrollTop + clientHeight) >= scrollHeight - 1;
    console.log(
      scrollTop + '+' + clientHeight + '=' + Math.ceil(scrollTop + clientHeight),
      scrollHeight
    );

    if (topIndicator) topIndicator.classList.toggle('opacity-0', isAtTop);
    if (bottomIndicator) bottomIndicator.classList.toggle('opacity-0', isAtBottom);
  };

  // Even though overflow is hidden, the 'scroll' event still fires when we move it via JS
  carousel.addEventListener('scroll', updateIndicators);
  // Initial check
  updateIndicators();

  // 2. Observer: Detect when the Hero section is FULLY visible
  const observer = new IntersectionObserver(
    ([entry]) => {
      // Ensure it is intersecting AND the top is at the viewport top
      // We use a small buffer (< 5) instead of < 1 to be more robust across browsers
      const isAtTop = entry.isIntersecting && Math.abs(entry.boundingClientRect.top) < 5;
      isHeroScrollActive = isAtTop;
    },
    { threshold: 1 }
  );

  if (heroSection) observer.observe(heroSection);

  // 3. Main Scroll Hijack Logic
  window.addEventListener(
    'wheel',
    (event) => {
      // RULE 1: If Hero is not locked, do NOT interfere.
      // Because the carousel is overflow-hidden, the browser ignores it
      // and scrolls the page naturally.
      if (!isHeroScrollActive) return;

      const { deltaY } = event;
      const { scrollTop, scrollHeight, clientHeight } = carousel;

      const isAtCarouselTop = scrollTop === 0;
      const isAtCarouselBottom = Math.ceil(scrollTop + clientHeight) >= scrollHeight;

      if (deltaY > 0) {
        // Scrolling DOWN
        if (!isAtCarouselBottom) {
          // Hijack: Scroll the carousel
          event.preventDefault();
          carousel.scrollBy({ top: deltaY, behavior: 'auto' });
        } else {
          // Release: Allow page to scroll down.
          // We set this false so the NEXT wheel event scrolls the page.
          isHeroScrollActive = false;
        }
      } else {
        // Scrolling UP
        if (!isAtCarouselTop) {
          // Hijack: Scroll the carousel
          event.preventDefault();
          carousel.scrollBy({ top: deltaY, behavior: 'auto' });
        } else {
          // Release: Allow page to scroll up.
          isHeroScrollActive = false;
        }
      }
    },
    { passive: false } // Required to use event.preventDefault()
  );
</script>
