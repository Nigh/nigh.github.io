---
import Profile from '../components/profilepic.astro';
import Brief from '../components/brief.astro';
import Skills from '../components/skill.astro';
import Contact from '../components/contact.astro';
import CrossfadeBackground from '../components/CrossfadeBackground.astro';
import bg1 from '../assets/bg1.jpg';
import bg2 from '../assets/bg2.jpg';
import bg3 from '../assets/bg3.jpg';
import bg4 from '../assets/bg4.jpg';
const backgrounds = [bg1.src, bg2.src, bg3.src, bg4.src];
const base = import.meta.env.PUBLIC_BASE_URL;
---

<div id="hero-section" class="flex flex-row gap-4 justify-center items-center w-screen h-screen">
  <CrossfadeBackground images={backgrounds} />
  <div id="hero-carousel" class="carousel carousel-vertical h-screen">
    <div class="carousel-item min-h-screen">
      <Brief />
    </div>
    <div class="carousel-item min-h-screen">
      <Skills />
    </div>
    <div class="carousel-item min-h-screen">
      <Contact />
    </div>
  </div>
  <div style="view-transition-name:profile;">
    <a href={base + 'about/'}>
      <Profile />
    </a>
  </div>
</div>

<script>
  const heroSection = document.getElementById('hero-section');
  const carousel = document.getElementById('hero-carousel');

  // This variable will act as our "scroll lock"
  let isHeroScrollActive = false;

  // 1. Observer to detect when the hero section is at the top
  const observer = new IntersectionObserver(
    ([entry]) => {
      // We check if it's 100% visible and at the top of the viewport
      const isAtTop = entry.isIntersecting && entry.boundingClientRect.top < 1;

      if (isAtTop) {
        isHeroScrollActive = true;
      } else {
        isHeroScrollActive = false;
      }
    },
    { threshold: 0.95 } // 1.0 means 100% of the element must be visible
  );
  observer.observe(heroSection);

  carousel.addEventListener(
    'wheel',
    (event) => {
      const { deltaY } = event;
      const { scrollTop, scrollHeight, clientHeight } = carousel;

      const isAtCarouselBottom = Math.ceil(scrollTop + clientHeight) >= scrollHeight;
      if (deltaY > 0 && isAtCarouselBottom) {
        event.preventDefault();
        window.scrollBy({ top: deltaY, behavior: 'auto' });
        return;
      }
      if (deltaY < 0 && window.scrollY !== 0) {
        event.preventDefault();
        window.scrollBy({ top: deltaY, behavior: 'auto' });
        return;
      }
    },
    { passive: false }
  );

  // 2. Main wheel event listener for the whole window
  window.addEventListener(
    'wheel',
    (event) => {
      // If the hero section isn't "locked" at the top,
      // just let the browser scroll normally.
      if (!isHeroScrollActive) {
        return;
      }

      // --- FROM THIS POINT ON, THE HERO IS AT THE TOP ---

      const { deltaY } = event; // How much the user scrolled
      const { scrollTop, scrollHeight, clientHeight } = carousel;

      // Check if the carousel is at the top or bottom
      // We use Math.ceil for sub-pixel precision
      const isAtCarouselTop = scrollTop === 0;
      const isAtCarouselBottom = Math.ceil(scrollTop + clientHeight) >= scrollHeight;

      if (deltaY > 0) {
        // User is scrolling DOWN
        if (!isAtCarouselBottom) {
          // We are NOT at the carousel bottom, so HIJACK the scroll
          event.preventDefault();
          // Manually scroll the carousel
          carousel.scrollBy({ top: deltaY, behavior: 'auto' });
        } else {
          // We ARE at the carousel bottom. RELEASE the hijack.
          // Let the main page scroll.
          isHeroScrollActive = false;
        }
      } else {
        // User is scrolling UP
        if (!isAtCarouselTop) {
          // We are NOT at the carousel top, so HIJACK the scroll
          event.preventDefault();
          // Manually scroll the carousel
          carousel.scrollBy({ top: deltaY, behavior: 'auto' });
        } else {
          // We ARE at the carousel top. RELEASE the hijack.
          // Let the main page scroll.
          isHeroScrollActive = false;
        }
      }
    },
    { passive: false }
  );
</script>
